<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Acompanhamento Semanal | Processos Jur√≠dicos</title>
    <!-- Tailwind CSS CDN para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- SweetAlert2 CDN para modais amig√°veis (Login, Edi√ß√£o, Exclus√£o) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS CDN para Exporta√ß√£o XLSX/Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <!-- Configura√ß√£o do Tailwind e Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        :root {
            --cor-principal: #3b82f6; /* Blue 500 */
            --cor-alerta: #ef4444; /* Red 500 */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Efeito de piscar em vermelho para processos urgentes (Prazo <= 2 dias) */
        @keyframes blink-red {
            0%, 100% { 
                border-color: var(--cor-alerta);
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            }
            50% { 
                border-color: transparent;
                box-shadow: none;
            }
        }

        .alert-blink {
            animation: blink-red 1.5s infinite;
            background-color: #fecaca; /* Red 200 de fundo suave */
        }

        /* Rolagem da Coluna Kanban */
        .kanban-cards-container {
            max-height: 60vh; /* Altura m√°xima para a rolagem */
            overflow-y: auto;
            padding-right: 8px; /* Espa√ßo para a barra de rolagem */
        }
        
        /* Cabe√ßalho Fixo do Kanban */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 1rem 0;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- HEADER -->
    <header class="bg-gray-800 text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold tracking-tight">‚öñÔ∏è Dashboard de Acompanhamento Semanal</h1>
             <div id="auth-status" class="text-sm font-light">
                <!-- Status de Autentica√ß√£o/ID do Usu√°rio ser√° injetado aqui -->
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- SE√á√ÉO 1: FILTROS E EXPORTA√á√ÉO -->
        <section class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">üîé Ferramenta de Filtros e Relat√≥rio</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                
                <div class="col-span-1 md:col-span-1">
                    <label for="filtro-colaborador" class="block text-sm font-medium text-gray-700">Colaborador</label>
                    <select id="filtro-colaborador" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white">
                        <option value="">Todos</option>
                    </select>
                </div>

                <div class="col-span-1 md:col-span-1">
                    <label for="filtro-data-registro" class="block text-sm font-medium text-gray-700">Data de Registro</label>
                    <input type="date" id="filtro-data-registro" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>

                <div class="col-span-1 md:col-span-1">
                    <label for="filtro-data-conclusao" class="block text-sm font-medium text-gray-700">Data de Conclus√£o</label>
                    <input type="date" id="filtro-data-conclusao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>

                <div class="col-span-1 flex space-x-2">
                    <button id="btn-limpar-filtros" class="w-full py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 transition">
                        <i class="fas fa-filter"></i> Limpar
                    </button>
                </div>
                
                <div class="col-span-1 md:col-span-2">
                    <!-- Bot√£o que aciona o modal de login para exporta√ß√£o. COMPORTAMENTO: Login -> Download XLSX. -->
                    <button id="btn-exportar-excel" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition">
                        <i class="fas fa-file-excel"></i> Extrair Relat√≥rio Completo
                    </button>
                </div>
            </div>
        </section>

        <!-- SE√á√ÉO 2: KANBAN DE PROCESSOS (O DASHBOARD QUE DEVE SEMPRE APARECER) -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìà Kanban de Processos</h2>
             <!-- Indicador de Carregamento -->
             <div id="loading-indicator" class="text-center p-6 text-blue-500 font-semibold hidden">
                <i class="fas fa-spinner fa-spin mr-2"></i> Carregando processos do Firestore...
            </div>
            <div id="kanban-board" class="flex overflow-x-auto space-x-4 pb-4">
                
                <!-- Coluna 1: Em Tratamento -->
                <div id="coluna-EmTratamento" class="kanban-column flex-shrink-0 w-80 bg-gray-200 rounded-lg p-3 shadow-inner">
                    <h3 class="sticky-header text-lg font-bold text-gray-800 bg-gray-200 border-b-2 border-blue-500">Em Tratamento (<span class="process-count">0</span>)</h3>
                    <div class="kanban-cards-container" data-status="Em Tratamento">
                        <!-- Cards -->
                    </div>
                </div>

                <!-- Coluna 2: Tratados na Semana -->
                <div id="coluna-TratadosnaSemana" class="kanban-column flex-shrink-0 w-80 bg-gray-200 rounded-lg p-3 shadow-inner">
                    <h3 class="sticky-header text-lg font-bold text-gray-800 bg-gray-200 border-b-2 border-yellow-500">Tratados na Semana (<span class="process-count">0</span>)</h3>
                    <div class="kanban-cards-container" data-status="Tratados na Semana">
                        <!-- Cards -->
                    </div>
                </div>

                <!-- Coluna 3: Pr√≥ximos Processos -->
                <div id="coluna-ProximosProcessos" class="kanban-column flex-shrink-0 w-80 bg-gray-200 rounded-lg p-3 shadow-inner">
                    <h3 class="sticky-header text-lg font-bold text-gray-800 bg-gray-200 border-b-2 border-purple-500">Pr√≥ximos Processos (<span class="process-count">0</span>)</h3>
                    <div class="kanban-cards-container" data-status="Pr√≥ximos Processos">
                        <!-- Cards -->
                    </div>
                </div>

                <!-- Coluna 4: Hist√≥rico de Conclu√≠dos -->
                <div id="coluna-HistoricodeConcluidos" class="kanban-column flex-shrink-0 w-80 bg-gray-200 rounded-lg p-3 shadow-inner">
                    <h3 class="sticky-header text-lg font-bold text-gray-800 bg-gray-200 border-b-2 border-green-500">Hist√≥rico de Conclu√≠dos (<span class="process-count">0</span>)</h3>
                    <div class="kanban-cards-container" data-status="Hist√≥rico de Conclu√≠dos">
                        <!-- Cards -->
                    </div>
                </div>

            </div>
        </section>

        <!-- SE√á√ÉO 3: REGISTRAR NOVO PROCESSO -->
        <section class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‚ûï Registrar Novo Processo</h2>
            <form id="form-novo-processo" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- Colaborador (Obrigat√≥rio) -->
                <div class="col-span-full sm:col-span-1">
                    <label for="colaborador-select" class="block text-sm font-medium text-gray-700">Colaborador <span class="text-red-500">*</span></label>
                    <select id="colaborador-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5" required>
                        <option value="" disabled selected>Selecione ou Gerencie</option>
                        <option value="gerenciar-colaboradores">‚ú® Gerenciar Colaboradores...</option>
                    </select>
                </div>

                <!-- Status do Processo (Obrigat√≥rio) -->
                <div class="col-span-full sm:col-span-1">
                    <label for="status-processo" class="block text-sm font-medium text-gray-700">Status do Processo <span class="text-red-500">*</span></label>
                    <select id="status-processo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5" required>
                        <option value="Em Tratamento">Em Tratamento</option>
                        <option value="Tratados na Semana">Tratados na Semana</option>
                        <option value="Pr√≥ximos Processos">Pr√≥ximos Processos</option>
                        <option value="Hist√≥rico de Conclu√≠dos">Hist√≥rico de Conclu√≠dos</option>
                    </select>
                </div>
                
                <!-- Data de Registro (Obrigat√≥rio) -->
                <div class="col-span-full sm:col-span-1">
                    <label for="data-registro" class="block text-sm font-medium text-gray-700">Data de Registro (Cadastro) <span class="text-red-500">*</span></label>
                    <input type="date" id="data-registro" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5" required>
                </div>

                <!-- Data de Previs√£o de Conclus√£o (AGORA OPCIONAL) -->
                <div class="col-span-full sm:col-span-1">
                    <label for="data-previsao" class="block text-sm font-medium text-gray-700">Data de Previs√£o de Conclus√£o (Opcional)</label>
                    <input type="date" id="data-previsao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5">
                </div>

                <!-- Data de Conclus√£o (Opcional) -->
                <div class="col-span-full sm:col-span-1">
                    <label for="data-conclusao" class="block text-sm font-medium text-gray-700">Data de Conclus√£o (Opcional)</label>
                    <input type="date" id="data-conclusao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5">
                </div>

                <!-- T√≠tulo do Processo/Tarefa (Obrigat√≥rio) -->
                <div class="col-span-full sm:col-span-1">
                    <label for="titulo-processo" class="block text-sm font-medium text-gray-700">T√≠tulo do Processo/Tarefa <span class="text-red-500">*</span></label>
                    <input type="text" id="titulo-processo" placeholder="Ex: Revis√£o de Contrato X - Cliente Alfa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5" required>
                </div>

                <!-- Observa√ß√µes -->
                <div class="col-span-full">
                    <label for="observacoes" class="block text-sm font-medium text-gray-700">Observa√ß√µes (Use quebras de linha/t√≥picos)</label>
                    <textarea id="observacoes" rows="3" placeholder="Ex: - Ponto 1: Verificar cl√°usula 5; - Ponto 2: Enviar para aprova√ß√£o da Dra. C√°ssia." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5"></textarea>
                </div>

                <!-- Bot√£o de Inclus√£o -->
                <div class="col-span-full pt-4">
                    <button type="submit" id="btn-incluir-processo" class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 transition">
                        <i class="fas fa-plus-circle"></i> Incluir Processo
                    </button>
                </div>
            </form>
        </section>
    </main>

<script type="module">
    // --- Configura√ß√£o e Vari√°veis Globais (Firebase) ---

    // IMPORTA√á√ïES DO FIREBASE (necess√°rio ser 'type="module"')
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Vari√°veis Globais fornecidas pelo ambiente
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let db;
    let auth;
    let userId = null;
    let processos = []; // O array de processos agora ser√° preenchido pelo Firestore
    let isAuthReady = false; // Flag para garantir que s√≥ tentemos opera√ß√µes ap√≥s a autentica√ß√£o

    // Defini√ß√£o da Collection Path para dados P√öBLICOS e colaborativos
    const getProcessosCollectionPath = () => `/artifacts/${appId}/public/data/processes`;

    // --- Configura√ß√µes Locais ---
    const USUARIOS_AUTORIZADOS = {
        'Dra. C√°ssia': '1234$C',
        'Dra. Jana√≠na': '5678$J'
    };

    let colaboradores = [
        'Beatriz', 'Diego', 'Emily', 'Felipe', 'Jo√£o', 'Jessica',
        'Jos√©', 'Giovana', 'Mariane', 'Rebeca', 'Tairane', 'Thais'
    ];
    
    // Chave de localStorage para colaboradores (mantida local para simplificar a gest√£o de permiss√µes)
    const LS_COLABORADORES = 'dashboardColaboradores';

    // Elementos do DOM
    const kanbanBoard = document.getElementById('kanban-board');
    const formNovoProcesso = document.getElementById('form-novo-processo');
    const colaboradorSelect = document.getElementById('colaborador-select');
    const filtroColaboradorSelect = document.getElementById('filtro-colaborador');
    const btnExportarExcel = document.getElementById('btn-exportar-excel');
    const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
    const filtroDataRegistro = document.getElementById('filtro-data-registro');
    const filtroDataConclusao = document.getElementById('filtro-data-conclusao');
    const loadingIndicator = document.getElementById('loading-indicator');


    // --- Fun√ß√µes de Inicializa√ß√£o e Autentica√ß√£o (FIREBASE) ---

    async function inicializarFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Configura√ß√£o do Firebase n√£o encontrada.");
            return;
        }

        try {
            // 1. Inicializa o App e Servi√ßos
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // Ativa o log para ver as opera√ß√µes do Firestore

            // 2. Tenta autenticar
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // 3. Listener de Estado de Autentica√ß√£o
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('auth-status').textContent = `Usu√°rio ID: ${userId}`;
                    
                    // Inicia a escuta dos dados ap√≥s a autentica√ß√£o
                    ouvirProcessos(); 
                } else {
                    userId = null;
                    isAuthReady = false;
                    document.getElementById('auth-status').textContent = 'Usu√°rio: Desconectado';
                }
            });

        } catch (error) {
            console.error("Erro na inicializa√ß√£o ou autentica√ß√£o do Firebase:", error);
            document.getElementById('auth-status').textContent = 'Erro de Conex√£o com Firebase';
        }
    }

    // --- Fun√ß√µes de Persist√™ncia (FIREBASE & LocalStorage para Colaboradores) ---

    function carregarColaboradores() {
        try {
            const colaboradoresSalvos = localStorage.getItem(LS_COLABORADORES);
            if (colaboradoresSalvos) {
                colaboradores = JSON.parse(colaboradoresSalvos);
            }
        } catch (error) {
            console.error("Erro ao carregar colaboradores do localStorage:", error);
        }
    }

    function salvarColaboradores() {
        localStorage.setItem(LS_COLABORADORES, JSON.stringify(colaboradores));
        renderizarSelects(); // Atualiza os selects ap√≥s salvar
    }
    
    /**
     * Usa onSnapshot para escutar mudan√ßas em tempo real no Firestore.
     */
    function ouvirProcessos() {
        loadingIndicator.classList.remove('hidden');
        if (!db || !isAuthReady) return;

        const colRef = collection(db, getProcessosCollectionPath());
        
        // Ativa o listener em tempo real
        onSnapshot(colRef, (snapshot) => {
            const processosFirestore = [];
            snapshot.forEach(doc => {
                // Mapeia o documento do Firestore, adicionando o ID
                processosFirestore.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            // Atualiza o array global de processos
            processos = processosFirestore;
            console.log("Processos carregados do Firestore:", processos.length);

            // Re-renderiza o Kanban com a nova lista (aplicando filtros, se houver)
            renderizarKanban(aplicarFiltros(processos));
            loadingIndicator.classList.add('hidden');
        }, (error) => {
            console.error("Erro ao escutar processos do Firestore:", error);
            loadingIndicator.classList.add('hidden');
            Swal.fire('Erro de Sincroniza√ß√£o', 'N√£o foi poss√≠vel carregar os dados em tempo real. Verifique o console.', 'error');
        });
    }


    // --- Renderiza√ß√£o de UI ---

    function renderizarSelects() {
        // Renderiza no Formul√°rio de Registro
        colaboradorSelect.innerHTML = '<option value="" disabled selected>Selecione</option><option value="gerenciar-colaboradores">‚ú® Gerenciar Colaboradores...</option>';
        // Renderiza no Filtro
        filtroColaboradorSelect.innerHTML = '<option value="">Todos</option>';

        colaboradores.sort().forEach(nome => {
            const option = document.createElement('option');
            option.value = nome;
            option.textContent = nome;
            colaboradorSelect.appendChild(option.cloneNode(true));
            filtroColaboradorSelect.appendChild(option);
        });
    }

    function renderizarKanban(listaProcessos = processos) {
        // Limpa todas as colunas
        document.querySelectorAll('.kanban-cards-container').forEach(container => container.innerHTML = '');

        const contadores = {
            'Em Tratamento': 0,
            'Tratados na Semana': 0,
            'Pr√≥ximos Processos': 0,
            'Hist√≥rico de Conclu√≠dos': 0
        };

        listaProcessos.forEach(processo => {
            const card = criarCardProcesso(processo);
            const container = document.querySelector(`.kanban-cards-container[data-status="${processo.status}"]`);
            if (container) {
                container.appendChild(card);
                contadores[processo.status]++;
            }
        });
        
        // Atualiza os contadores no cabe√ßalho
        document.getElementById('coluna-EmTratamento').querySelector('.process-count').textContent = contadores['Em Tratamento'];
        document.getElementById('coluna-TratadosnaSemana').querySelector('.process-count').textContent = contadores['Tratados na Semana'];
        document.getElementById('coluna-ProximosProcessos').querySelector('.process-count').textContent = contadores['Pr√≥ximos Processos'];
        document.getElementById('coluna-HistoricodeConcluidos').querySelector('.process-count').textContent = contadores['Hist√≥rico de Conclu√≠dos'];
        
        // Aplica o Drag and Drop ap√≥s renderizar
        adicionarListenersDragAndDrop();
    }

    function criarCardProcesso(processo) {
        const card = document.createElement('div');
        // Usa o ID do documento do Firestore como ID do Card
        card.id = `card-${processo.id}`; 
        card.className = 'kanban-card p-4 bg-white rounded-lg shadow-md mb-3 border-l-4 border-blue-400 hover:shadow-lg transition cursor-move';
        card.setAttribute('draggable', true);
        card.setAttribute('data-id', processo.id);
        
        // Verifica se o processo foi conclu√≠do (se tem data de conclus√£o)
        const isConcluido = !!processo.dataConclusao;
        
        // Somente calcula urg√™ncia se o processo n√£o estiver conclu√≠do e tiver uma data de previs√£o
        if (!isConcluido && processo.dataPrevisao) {
            const hoje = new Date();
            const dataPrevisao = new Date(processo.dataPrevisao);
            
            hoje.setHours(0, 0, 0, 0); 
            
            const diferencaDias = Math.ceil((dataPrevisao.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24));

            if (diferencaDias >= 0 && diferencaDias <= 2) {
                card.classList.add('alert-blink', 'border-red-600');
            } else if (diferencaDias < 0) {
                card.classList.remove('border-blue-400');
                card.classList.add('border-red-600'); 
            }
        }
        
        const dataConc = isConcluido ? `Conclu√≠do: ${processo.dataConclusao}` : 'Aguardando Conclus√£o';
        const dataPrevDisplay = processo.dataPrevisao ? processo.dataPrevisao : 'N/A';

        card.innerHTML = `
            <div class="font-bold text-gray-800">${processo.titulo}</div>
            <div class="text-xs text-gray-500 mt-1">Colab: ${processo.colaborador}</div>
            <div class="text-xs text-gray-500">Reg: ${processo.dataRegistro} | Prev: <span class="font-semibold">${dataPrevDisplay}</span></div>
            <div class="text-xs text-gray-500">${dataConc}</div>
            <div class="mt-3 flex justify-end space-x-2">
                <button onclick="window.editarProcesso('${processo.id}')" class="text-blue-500 hover:text-blue-700 text-sm transition"><i class="fas fa-edit"></i> Editar</button>
                <button onclick="window.excluirProcesso('${processo.id}')" class="text-red-500 hover:text-red-700 text-sm transition"><i class="fas fa-trash"></i> Excluir</button>
            </div>
        `;
        return card;
    }

    // --- Fun√ß√µes de Gerenciamento de Processos (CRUD - FIREBASE) ---

    async function adicionarNovoProcesso(e) {
        e.preventDefault();
        
        if (!isAuthReady) {
            Swal.fire('Erro', 'Aguarde a conex√£o com o banco de dados antes de adicionar.', 'error');
            return;
        }

        if (colaboradorSelect.value === 'gerenciar-colaboradores') {
            abrirModalColaboradores();
            return;
        }

        const novoProcesso = {
            colaborador: colaboradorSelect.value,
            status: document.getElementById('status-processo').value,
            dataRegistro: document.getElementById('data-registro').value,
            dataPrevisao: document.getElementById('data-previsao').value || null, 
            dataConclusao: document.getElementById('data-conclusao').value || null,
            titulo: document.getElementById('titulo-processo').value,
            observacoes: document.getElementById('observacoes').value,
            // Metadados importantes para o Firestore:
            createdAt: new Date().toISOString(),
            createdBy: userId 
        };

        if (!novoProcesso.colaborador || !novoProcesso.status || !novoProcesso.dataRegistro || !novoProcesso.titulo) {
            Swal.fire('Erro', 'Por favor, preencha os campos obrigat√≥rios (marcados com *)', 'error');
            return;
        }

        try {
            // Usa addDoc para adicionar um novo documento com ID gerado automaticamente
            await addDoc(collection(db, getProcessosCollectionPath()), novoProcesso);
            
            Swal.fire('Sucesso!', 'Novo processo registrado com sucesso e sincronizado!', 'success');
            formNovoProcesso.reset();
            document.getElementById('data-registro').valueAsDate = new Date(); // Mant√©m a data de hoje
        } catch (error) {
            console.error("Erro ao adicionar processo ao Firestore:", error);
            Swal.fire('Erro de Grava√ß√£o', 'N√£o foi poss√≠vel salvar o processo. Verifique as permiss√µes.', 'error');
        }
    }

    // Fun√ß√£o global para ser chamada pelo HTML
    window.excluirProcesso = async function(id) {
        if (!isAuthReady) {
            Swal.fire('Erro', 'Aguarde a conex√£o com o banco de dados.', 'error');
            return;
        }

        Swal.fire({
            title: 'Tem certeza?',
            text: "Esta a√ß√£o apagar√° o processo para todos os colaboradores!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim, excluir!',
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    // Usa deleteDoc para remover o documento
                    await deleteDoc(doc(db, getProcessosCollectionPath(), id));
                    Swal.fire('Exclu√≠do!', 'O processo foi exclu√≠do e removido para todos.', 'success');
                    // O onSnapshot cuidar√° da remo√ß√£o na UI
                } catch (error) {
                    console.error("Erro ao excluir processo do Firestore:", error);
                    Swal.fire('Erro', 'N√£o foi poss√≠vel excluir o processo. Verifique as permiss√µes.', 'error');
                }
            }
        });
    }

    // Fun√ß√£o global para ser chamada pelo HTML
    window.editarProcesso = function(id) {
        const processo = processos.find(p => p.id === id);
        if (!processo) return;

        Swal.fire({
            title: `Editar Processo: ${processo.titulo}`,
            html: `
                <div class="text-left mt-4 space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Colaborador <span class="text-red-500">*</span></label>
                    <select id="swal-colaborador" class="w-full border p-2 rounded">${colaboradores.map(c => `<option value="${c}" ${processo.colaborador === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                    
                    <label class="block text-sm font-medium text-gray-700">Status <span class="text-red-500">*</span></label>
                    <select id="swal-status" class="w-full border p-2 rounded">
                        ${['Em Tratamento', 'Tratados na Semana', 'Pr√≥ximos Processos', 'Hist√≥rico de Conclu√≠dos'].map(s => `<option value="${s}" ${processo.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>

                    <label class="block text-sm font-medium text-gray-700">T√≠tulo <span class="text-red-500">*</span></label>
                    <input id="swal-titulo" type="text" class="w-full border p-2 rounded" value="${processo.titulo}">
                    
                    <label class="block text-sm font-medium text-gray-700">Previs√£o (YYYY-MM-DD - Opcional)</label>
                    <input id="swal-data-previsao" type="date" class="w-full border p-2 rounded" value="${processo.dataPrevisao || ''}">

                    <label class="block text-sm font-medium text-gray-700">Conclus√£o (YYYY-MM-DD - Opcional)</label>
                    <input id="swal-data-conclusao" type="date" class="w-full border p-2 rounded" value="${processo.dataConclusao || ''}">

                    <label class="block text-sm font-medium text-gray-700">Observa√ß√µes</label>
                    <textarea id="swal-observacoes" class="w-full border p-2 rounded">${processo.observacoes}</textarea>
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Salvar Altera√ß√µes',
            preConfirm: () => {
                const titulo = document.getElementById('swal-titulo').value;
                const colaborador = document.getElementById('swal-colaborador').value;
                const status = document.getElementById('swal-status').value;
                const dataPrevisao = document.getElementById('swal-data-previsao').value;
                const dataConclusao = document.getElementById('swal-data-conclusao').value;
                const observacoes = document.getElementById('swal-observacoes').value;

                if (!titulo || !colaborador || !status) {
                    Swal.showValidationMessage('Os campos obrigat√≥rios (marcados com *) devem ser preenchidos.');
                    return false;
                }
                return { 
                    titulo, 
                    colaborador, 
                    status, 
                    dataPrevisao: dataPrevisao || null, 
                    dataConclusao: dataConclusao || null,
                    observacoes 
                };
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                if (!isAuthReady) {
                    Swal.fire('Erro', 'Aguarde a conex√£o com o banco de dados.', 'error');
                    return;
                }
                
                try {
                    const data = result.value;
                    // Usa updateDoc para atualizar o documento no Firestore
                    await updateDoc(doc(db, getProcessosCollectionPath(), id), {
                        titulo: data.titulo,
                        colaborador: data.colaborador,
                        status: data.status,
                        dataPrevisao: data.dataPrevisao,
                        dataConclusao: data.dataConclusao,
                        observacoes: data.observacoes,
                        updatedAt: new Date().toISOString() // Adiciona data de atualiza√ß√£o
                    });

                    Swal.fire('Salvo!', 'O processo foi atualizado e sincronizado.', 'success');
                    // O onSnapshot cuidar√° da atualiza√ß√£o na UI
                } catch (error) {
                    console.error("Erro ao atualizar processo no Firestore:", error);
                    Swal.fire('Erro de Grava√ß√£o', 'N√£o foi poss√≠vel atualizar o processo. Verifique as permiss√µes.', 'error');
                }
            }
        });
    }

    // --- Gerenciamento de Colaboradores (Local) ---

    // [As fun√ß√µes de gerenciamento de colaboradores (abrirModalColaboradores, renderizarListaColaboradoresModal, adicionarColaborador, excluirColaborador) permanecem USANDO LOCALSTORAGE para simplificar, pois n√£o s√£o dados essenciais de colabora√ß√£o em tempo real.]

    function abrirModalColaboradores() {
        Swal.fire({
            title: 'Gerenciar Colaboradores',
            html: `
                <div class="mt-4">
                    <input id="novo-colaborador-nome" class="w-full border p-2 rounded mb-3" placeholder="Novo nome do colaborador">
                    <button id="btn-adicionar-colaborador" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition mb-4">Adicionar Colaborador</button>
                    <div id="lista-colaboradores" class="max-h-60 overflow-y-auto border p-2 rounded text-left space-y-1">
                        <!-- Lista de colaboradores aqui -->
                    </div>
                </div>
            `,
            showConfirmButton: false,
            showCloseButton: true,
            didOpen: () => {
                renderizarListaColaboradoresModal();
                document.getElementById('btn-adicionar-colaborador').onclick = adicionarColaborador;
            }
        });
    }

    function renderizarListaColaboradoresModal() {
        const listaDiv = document.getElementById('lista-colaboradores');
        listaDiv.innerHTML = '';
        
        colaboradores.sort().forEach(nome => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-1 border-b last:border-b-0';
            item.innerHTML = `
                <span>${nome}</span>
                <button onclick="window.excluirColaboradorLocal('${nome}')" class="text-red-500 hover:text-red-700 transition">
                    <i class="fas fa-times-circle"></i> Excluir
                </button>
            `;
            listaDiv.appendChild(item);
        });
    }

    function adicionarColaborador() {
        const nomeInput = document.getElementById('novo-colaborador-nome');
        const nome = nomeInput.value.trim();

        if (nome && !colaboradores.includes(nome)) {
            colaboradores.push(nome);
            salvarColaboradores();
            renderizarListaColaboradoresModal();
            nomeInput.value = '';
            Swal.fire('Adicionado!', `${nome} foi adicionado √† lista.`, 'success');
        } else if (colaboradores.includes(nome)) {
            Swal.fire('Aten√ß√£o', `${nome} j√° existe na lista.`, 'warning');
        }
    }

    window.excluirColaboradorLocal = function(nome) {
         Swal.fire({
            title: `Excluir ${nome}?`,
            text: "Os processos deste colaborador permanecer√£o, mas o nome ser√° removido das op√ß√µes futuras.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sim, remover!'
        }).then((result) => {
            if (result.isConfirmed) {
                colaboradores = colaboradores.filter(c => c !== nome);
                salvarColaboradores();
                renderizarListaColaboradoresModal();
                Swal.fire('Removido!', `${nome} foi removido.`, 'success');
            }
        });
    }

    
    // --- Fun√ß√µes de Filtro ---

    function aplicarFiltros(data = processos) {
        const colabFiltro = filtroColaboradorSelect.value;
        const regFiltro = filtroDataRegistro.value;
        const concFiltro = filtroDataConclusao.value;

        let processosFiltrados = data;

        // Filtro por Colaborador
        if (colabFiltro) {
            processosFiltrados = processosFiltrados.filter(p => p.colaborador === colabFiltro);
        }

        // Filtro por Data de Registro
        if (regFiltro) {
            processosFiltrados = processosFiltrados.filter(p => p.dataRegistro === regFiltro);
        }

        // Filtro por Data de Conclus√£o
        if (concFiltro) {
            processosFiltrados = processosFiltrados.filter(p => p.dataConclusao === concFiltro);
        }

        renderizarKanban(processosFiltrados);
        return processosFiltrados;
    }

    function limparFiltros() {
        filtroColaboradorSelect.value = '';
        filtroDataRegistro.value = '';
        filtroDataConclusao.value = '';
        renderizarKanban(processos);
    }

    // --- FUN√á√ÉO DE EXPORTA√á√ÉO E LOGIN RESTRITO ---

    /**
     * Fun√ß√£o principal acionada pelo bot√£o "Extrair Relat√≥rio Completo".
     * Esta fun√ß√£o solicita o login seguro e, se bem-sucedido, realiza o download do Excel.
     */
    function exportarParaExcel() {
        // [L√≥gica de SVG de Seguran√ßa Omitida para brevidade]
        const svgSeguranca = encodeURIComponent(`<svg width="200" height="100" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100"><rect width="200" height="100" fill="#f0f0f0" rx="10"/><circle cx="50" cy="50" r="20" fill="#3b82f6"/><rect x="90" y="35" width="90" height="10" fill="#1f2937"/><rect x="90" y="55" width="70" height="10" fill="#1f2937"/><text x="100" y="85" font-size="12" fill="#ef4444" text-anchor="middle">Acesso Seguro - Dras. C e J</text></svg>`);
        const imageUrl = 'data:image/svg+xml;utf8,' + svgSeguranca;

        Swal.fire({
            title: 'Acesso Restrito - Exporta√ß√£o',
            html: `
                <div class="p-4 bg-gray-100 rounded-lg">
                    <img src="${imageUrl}" alt="Imagem de Seguran√ßa" class="mx-auto my-4 border border-gray-300 rounded-lg shadow-md max-w-full">
                    <p class="text-sm text-gray-600 mb-4">A exporta√ß√£o do relat√≥rio completo requer Login Seguro.</p>
                    <input id="swal-login" type="text" class="w-full border p-3 rounded mb-2" placeholder="Login (Ex: Dra. C√°ssia)">
                    <input id="swal-senha" type="password" class="w-full border p-3 rounded" placeholder="Senha">
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Confirmar Login e Exportar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const login = document.getElementById('swal-login').value.trim();
                const senha = document.getElementById('swal-senha').value.trim();
                if (!login || !senha) {
                    Swal.showValidationMessage('Por favor, preencha Login e Senha.');
                    return false;
                }
                if (USUARIOS_AUTORIZADOS[login] === senha) {
                    return true;
                } else {
                    Swal.showValidationMessage('Login ou Senha incorretos. Acesso negado.');
                    return false;
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                if (processos.length === 0) {
                    Swal.fire('Aten√ß√£o', 'N√£o h√° processos registrados para exportar.', 'warning');
                    return;
                }
                
                // Mapeia os dados do Firestore para o formato de planilha
                const dadosPlanilha = processos.map(p => ({
                    ID: p.id,
                    'Colaborador Respons√°vel': p.colaborador,
                    Status: p.status,
                    'Data de Registro': p.dataRegistro,
                    'Data de Previs√£o': p.dataPrevisao || 'N/A',
                    'Data de Conclus√£o': p.dataConclusao || 'Pendente',
                    'T√≠tulo do Processo/Tarefa': p.titulo,
                    Observa√ß√µes: p.observacoes
                }));

                const worksheet = XLSX.utils.json_to_sheet(dadosPlanilha);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'RelatorioProcessos');

                const hoje = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(workbook, `Relatorio_Processos_${hoje}.xlsx`);
                
                Swal.fire('Sucesso!', 'Relat√≥rio exportado com sucesso.', 'success');
            }
        });
    }

    // --- Fun√ß√µes de Drag and Drop (Kanban - FIREBASE) ---

    let draggedItem = null;

    function adicionarListenersDragAndDrop() {
        document.querySelectorAll('.kanban-card').forEach(card => {
            card.addEventListener('dragstart', (e) => {
                draggedItem = e.target;
                e.target.classList.add('opacity-50');
            });

            card.addEventListener('dragend', (e) => {
                e.target.classList.remove('opacity-50');
                draggedItem = null;
            });
        });

        document.querySelectorAll('.kanban-cards-container').forEach(container => {
            container.addEventListener('dragover', (e) => {
                e.preventDefault(); // Permite o drop
            });

            container.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (draggedItem && isAuthReady) {
                    const novoStatus = container.getAttribute('data-status');
                    const processoId = draggedItem.getAttribute('data-id');
                    
                    const processo = processos.find(p => p.id === processoId);
                    if (processo && processo.status !== novoStatus) {
                        
                        let dataConclusaoAtualizada = processo.dataConclusao;

                        // L√≥gica de atualiza√ß√£o de Data de Conclus√£o
                        if (novoStatus === 'Hist√≥rico de Conclu√≠dos' && !processo.dataConclusao) {
                            dataConclusaoAtualizada = new Date().toISOString().slice(0, 10);
                        } else if (novoStatus !== 'Hist√≥rico de Conclu√≠dos') {
                            dataConclusaoAtualizada = null;
                        }
                        
                        try {
                            // Atualiza o status e a data de conclus√£o no Firestore
                            await updateDoc(doc(db, getProcessosCollectionPath(), processoId), {
                                status: novoStatus,
                                dataConclusao: dataConclusaoAtualizada,
                                updatedAt: new Date().toISOString()
                            });
                            // O onSnapshot vai mover o card na UI, ent√£o n√£o precisamos mexer no DOM aqui.
                        } catch (error) {
                            console.error("Erro ao atualizar status do processo no Firestore:", error);
                            Swal.fire('Erro', 'N√£o foi poss√≠vel atualizar o status no banco de dados.', 'error');
                        }
                    }
                }
            });
        });
    }

    // --- Inicializa√ß√£o e Event Listeners ---

    window.onload = function() {
        inicializarFirebase(); // Inicia a conex√£o com o Firebase e a escuta em tempo real
        carregarColaboradores(); // Mant√©m o carregamento de colaboradores local
        renderizarSelects();
        
        // Define a data de registro para hoje por padr√£o
        document.getElementById('data-registro').valueAsDate = new Date();
    };

    // Listeners de Eventos
    formNovoProcesso.addEventListener('submit', adicionarNovoProcesso);
    btnExportarExcel.addEventListener('click', exportarParaExcel); 
    btnLimparFiltros.addEventListener('click', limparFiltros);
    // Os filtros agora chamam a fun√ß√£o que aplica os filtros no array 'processos'
    filtroColaboradorSelect.addEventListener('change', () => aplicarFiltros());
    filtroDataRegistro.addEventListener('change', () => aplicarFiltros());
    filtroDataConclusao.addEventListener('change', () => aplicarFiltros());
    
    // Listener para o campo Colaborador (para abrir o modal de gerenciamento)
    colaboradorSelect.addEventListener('change', (e) => {
        if (e.target.value === 'gerenciar-colaboradores') {
            abrirModalColaboradores();
            e.target.value = ''; 
        }
    });

    // Torna as fun√ß√µes de CRUD globais para que os bot√µes dentro do card (criado dinamicamente) possam acess√°-las
    window.editarProcesso = editarProcesso; 
    window.excluirProcesso = excluirProcesso;
</script>

</body>
</html>
